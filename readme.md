PPO+ActionMask for Tennis RL

### é¡¹ç›®ç®€ä»‹

å—åˆ°bç«™UPè®­ç»ƒç½‘çƒRLçš„è§†é¢‘çš„é©±åŠ¨ï¼Œ ä¹Ÿè®­ç»ƒäº†ä¸‹è‡ªå·±çš„RLï¼Œè¿™è¾¹è®°å½•ä¸‹è‡ªå·±çš„æ–¹æ¡ˆå’Œè®­ç»ƒç»“æœã€‚

è¯•è¿‡DQN+ä¸¤é˜¶æ®µè®­ç»ƒçš„æ–¹æ¡ˆï¼Œä½†æ˜¯DQNçš„æ”¶æ•›é€Ÿåº¦å®åœ¨å¤ªæ…¢äº†ï¼Œæ²¡æœ‰æ€ä¹ˆè®­ç»ƒå‡ºæ¥ğŸ™ã€‚ç„¶åå°±è½¬ç”¨ppoç®—æ³•è®­ç»ƒï¼Œä½œä¸ºon-policyçš„ç®—æ³•ï¼Œæ”¶æ•›é€Ÿåº¦æ˜æ˜¾å¥½è¿‡äºDQNã€‚ä½†æ˜¯è®­ç»ƒè¿‡ç¨‹ä¸­æ€»ä¼šå‡ºç°è¾¾åˆ°æœ€å¤§ *episodic-length* çš„æƒ…å†µï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸¤æ–¹å¯¹æ‰“æ€»æœ‰å®åŠ›çš„è½å·®ï¼Œåœ¨ä¸€å®šstepså†…æ€»ä¼šåˆ†å‡ºèƒœè´Ÿã€‚è¿™æ˜¾ç„¶åˆæ˜¯å‡ºç°äº†â€œæ‘†çƒ‚â€é—®é¢˜ğŸ¤”ï¼Œ è‡ªå·±RLåœ¨åº”è¯¥å¼€çƒçš„æ—¶å€™ä¸â€œå¼€çƒâ€ï¼Œäºæ˜¯â€œæ‘†çƒ‚â€è€—åˆ°æœ€å¤§ *episodic-length*ğŸ¤£ã€‚

äºæ˜¯æˆ‘å¼€å§‹åœ¨æ¸¸æˆç¯å¢ƒä¸‹åšç ”ç©¶ï¼Œå› ä¸ºç¯å¢ƒä¸ä¼šæ˜¾å¼æä¾› â€œå¼€çƒçŠ¶æ€â€ ç­‰ä¿¡æ¯ï¼Œæ‰€ä»¥éœ€è¦æ ¹æ®rewardå’Œç½‘çƒè§„åˆ™æ‰‹åŠ¨åˆ¤æ–­æ˜¯å¦åœ¨å¼€çƒçŠ¶æ€ã€‚ åŸºäºè¿™ä¸ªæ€è·¯ï¼Œæˆ‘å®Œæˆäº† *tennis-wrapper* çš„è®¾è®¡ï¼Œåœ¨ç¯å¢ƒä¸­æš´éœ²ä¸€ä¸ª *action_mask* æ¥å£ï¼ŒåŒæ—¶ä¹Ÿè§£å†³äº†ä¸€ä¸ªå°å›åˆç»“æŸåçš„åƒµç›´é—®é¢˜ğŸ˜Šã€‚åœ¨PPOç®—æ³•ä¸­åŠ å…¥maskï¼Œå¯¹äºéæ³•actionçš„ *logits* è®¾ä¸ºè´Ÿæ— ç©·ï¼Œè¿™æ ·agentå°±ä¸ä¼šé€‰æ‹©è¿™ä¸ªåŠ¨ä½œäº†ã€‚

### å®‰è£…ä¾èµ–

| åº“å          | ç‰ˆæœ¬è¦æ±‚ |
| ------------- | -------- |
| ale-py        | 0.7.5    |
| AutoROM       | 0.5.4    |
| opencv-python | -        |
| gym           | 0.23.1   |
| tensorboard   | -        |
| numpy         | -        |
| torch         | -        |

### è®­ç»ƒ

```bash
python ppo_tennis.py
```

Cleanrlé»˜è®¤è®­ç»ƒæ€»æ­¥é•¿ä¸º10 millonï¼Œå¯é€šè¿‡ `--total-timesteps` å‚æ•°æ›´æ”¹è®¾ç½®ï¼›å®æµ‹ 20 - 30 millon å®Œå…¨æ”¶æ•›ã€‚å¯ä»¥ä½¿ç”¨ `tensorboard` è§‚å¯Ÿè®­ç»ƒè¿‡ç¨‹ï¼Œå¦‚å›¾ï¼š

![image-20230301120753470](https://cdn.jsdelivr.net/gh/QYHcrossover/blog-imgbed/blogimgimage-20230301120753470.png)

å…¶ä¸­ `mean_rewards` è¾¹è®­ç»ƒè¾¹å¤šæ¬¡è¯„ä¼°çš„å¹³å‡rewardçš„æƒ…å†µï¼Œå¯ä»¥å‘ç°æ— è®ºæ˜¯ `episodic-return` è¿˜æ˜¯ `mean_rewards` éƒ½æ˜¯ç¨³æ­¥ä¸Šå‡çš„ã€‚

### è¯„ä¼°

```bash
python ppo_tennis.py --eval
```

é»˜è®¤åŠ è½½çš„æ˜¯ `models/TennisNoFrameskip-v4__ppo_tennis__1__1658753671/best.pt`  è¿™ä¸ªè®­ç»ƒå¥½çš„æ¨¡å‹ï¼Œ é€šè¿‡ `--model-path` æ›´æ”¹å¾…è¯„ä¼°æ¨¡å‹åœ°å€ï¼Œéƒ¨åˆ†è¯„ä¼°å½•åƒæ•ˆæœå±•ç¤ºå¦‚ä¸‹ï¼š

![tennis4](https://cdn.jsdelivr.net/gh/QYHcrossover/blog-imgbed/blogimgtennis4.gif)

### wrapperç»†èŠ‚

é¦–å…ˆäº†è§£ä¸‹atariä¸‹tennisçš„è§„åˆ™ï¼ŒåŒç°å®ç½‘çƒæ¯”èµ›ä¸€æ ·, ä¸€ç›˜æ¯”èµ›çš„è·èƒœæ¡ä»¶å¦‚ä¸‹

> ä¸€æ–¹å…ˆèƒœ6å±€ä¸ºèƒœ1ç›˜ï¼›åŒæ–¹å„èƒœ5å±€æ—¶ï¼Œä¸€æ–¹å‡€èƒœä¸¤å±€ä¸ºèƒœ1ç›˜ã€‚

è€Œæ¯ä¸ªå°å±€çš„è·èƒœæ¡ä»¶å¦‚ä¸‹ï¼š

> æ¯èƒœ1çƒå¾—1åˆ†ï¼Œå…ˆèƒœ4åˆ†è€…èƒœ1å±€ã€‚åŒæ–¹å„å¾—3åˆ†æ—¶ä¸ºâ€œå¹³åˆ†â€ï¼Œå¹³åˆ†åï¼Œå‡€èƒœä¸¤åˆ†ä¸ºèƒœ1å±€ã€‚

å…¶æ¬¡æ¯ä¸ªå°å±€è¿‡å**ç”±çƒå‘˜äº¤æ›¿å‘çƒ**

å› æ­¤`tennis-wrapper` éœ€è¦åœ¨é‡è½½`reset`å‡½æ•°æ—¶ï¼Œéœ€è¦åˆå§‹åŒ– **å°å±€æ¯”åˆ†**ï¼Œ**å¤§æ¯”åˆ†**ï¼Œ **å‘çƒæ‰‹** ä¸‰ä¸ªä¿¡æ¯

```python
class TennisWrapper2(gym.Wrapper):
    def reset(self, **kwargs):
        obs = self.env.reset(**kwargs)
        self.current_score = [0,0] #å°æ¯”åˆ†
        self.score = [0,0] #å¤§æ¯”åˆ†
        self.server = 0 #å‘çƒæ‰‹, ä¸€å¼€å§‹æ—¶ä¸º player0
        return obs
```

æ­¤å¤–åœ¨ é‡è½½ `step` å‡½æ•°æ—¶ï¼Œéœ€è¦æ ¹æ®rewardä¿¡æ¯åˆ¤æ–­ä¸€å›åˆç»“æŸï¼Œå½“å›åˆç»“æŸæ—¶éœ€è¦

- æ ¹æ®è§„åˆ™**æ›´æ–°å°æ¯”åˆ†å’Œå¤§æ¯”åˆ†**
- å¦‚æœä¸€å°å±€æ¯”èµ›ç»“æŸï¼Œåˆ™éœ€è¦**æ›´æ¢å‘çƒæ‰‹**ï¼Œå¹¶åœ¨infoä¸­æ˜¾å¼è¿”å›å‘çƒæ‰‹çš„action_mask
- å°å±€æ¯”èµ›ç»“æŸï¼Œä¹Ÿéœ€è¦æ˜¾å¼è°ƒç”¨ run_reset **å¤„ç†åƒµç›´é—®é¢˜** 

```python
    def step(self, action):
        #åˆ¤æ–­actionæ˜¯å¦illegel
        assert self.action_mask[action], "not a legal action"
        #æ‰§è¡Œç›¸åº”çš„åŠ¨ä½œ
        obs, reward, done, info = self.env.step(action)
        #æ¯å›åˆç»“æŸ
        if reward != 0:
            run_winner = 0 if reward == 1 else 1
            run_winner = 0 if reward == 1 else 1
            self.current_score[run_winner] += 1
            # æ¯å°å±€èƒœåˆ©æ¡ä»¶
            if self.current_score[run_winner] >= 4 and self.current_score[run_winner] - self.current_score[1-run_winner]>=2:      
                self.current_score = [0,0]
                self.score[run_winner] += 1
                self.server = 1 - self.server #æ›´æ¢å‘çƒè€…
            obs = self.run_reset(obs.copy())
        info["action_mask"] = self.action_mask
        return obs, reward, done, info
```

åœ¨å¼€çƒçŠ¶æ€ä¸‹å“ªäº›åŠ¨ä½œä¸ºéæ³•åŠ¨ä½œå‘¢ ï¼Œè¿™ä¸ªå°±éœ€è¦æŸ¥è¯¢å®˜ç½‘äº†, å„ä¸ªåŠ¨ä½œè¡Œä¸ºè§£é‡Šå¦‚ä¸‹ï¼š

![](https://cdn.jsdelivr.net/gh/QYHcrossover/blog-imgbed/blogimgimage-20230301141120851.png)

å«æœ‰Fireçš„Actionä¸ºåˆæ³•çš„å¼€çƒåŠ¨ä½œï¼ŒåŸºäºæ­¤å®Œæˆ action_mask å‡½æ•°

```python
    @property
    def action_mask(self):
        am = np.array([True]*self.action_space.n)
        if self.server == 0 and self.run_length == 0:
            am[[0] + list(range(2,10))] = False
        return am
```

æ‰€è°“çš„åƒµç›´é—®é¢˜ï¼Œåˆ™ä¸ºå°å±€ç»“æŸåä¸€æ®µæ—¶é—´å†…ï¼›æ— è®ºä¼ å…¥ä»€ä¹ˆActionï¼Œéƒ½æ²¡æœ‰æ•ˆæœï¼Œæ¸¸æˆç”»é¢ä¹Ÿä¸åŠ¨ã€‚æ­¤æ—¶æˆ‘ä»¬é€‰æ‹©æ‰‹åŠ¨ä¼ å…¥æ—¶é—´çš„ actionï¼š0ä¹Ÿå°±æ˜¯ `no-op` å¾…åƒµç›´é—®é¢˜æ¢å¤åï¼Œå†è¿›è¡Œæ­£å¸¸çš„è®­ç»ƒã€‚
